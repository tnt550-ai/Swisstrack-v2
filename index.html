<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SwissTrack Pro V11</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#dc2626">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .progress-ga { transition: width 1.2s ease-in-out; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #334155; }
        .suggestions-container { 
            position: absolute; z-index: 50; width: 100%; 
            background: white; border-radius: 12px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); 
            margin-top: 4px; max-height: 240px; overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        .card-grad { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
        .edit-mode { border: 2px solid #fca5a5 !important; background-color: #fef2f2; }
    </style>
</head>
<body class="bg-slate-50 font-sans pb-20 min-h-screen text-slate-900">

<div class="max-w-md mx-auto p-4">
    <header class="flex justify-between items-center mb-6 pt-2">
        <h1 class="text-2xl font-black text-red-600 tracking-tighter">SWISSTRACK</h1>
        <button onclick="backupData()" class="p-2 bg-white rounded-full border border-slate-200 shadow-sm">
            <i data-lucide="database" class="w-5 h-5 text-slate-400"></i>
        </button>
    </header>

    <div class="card-grad p-6 rounded-[2.5rem] shadow-xl text-white mb-6">
        <div class="flex justify-between items-start">
            <span class="text-[10px] font-bold opacity-70 uppercase tracking-widest">GA-Check bis 11.08.2026</span>
            <div id="dataBadge" class="hidden bg-white/20 px-2 py-1 rounded text-[9px] font-bold">LERNPHASE</div>
        </div>
        
        <div class="text-4xl font-black mb-1 mt-1">CHF <span id="projectedYear">0</span></div>
        <p class="text-[11px] opacity-90 mb-4 leading-tight" id="predictionMsg">Sammle Daten...</p>
        
        <div class="w-full bg-white/20 h-2 rounded-full overflow-hidden mb-2">
            <div id="gaProgress" class="progress-ga bg-white h-full" style="width: 0%"></div>
        </div>
        <div class="flex justify-between text-[9px] font-bold opacity-70 uppercase">
            <span id="spentLabel">Aktuell: CHF 0.00</span>
            <span>GA: CHF 3'995.-</span>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-6">
        <div class="bg-white p-4 rounded-3xl border border-slate-200 shadow-sm">
            <span class="block text-[9px] font-bold text-slate-400 uppercase tracking-wider">KM Total</span>
            <span id="totalKM" class="text-xl font-black">0.0</span>
        </div>
        <div class="bg-white p-4 rounded-3xl border border-slate-200 shadow-sm">
            <span class="block text-[9px] font-bold text-slate-400 uppercase tracking-wider">√ò CHF / KM</span>
            <span id="avgPrice" class="text-xl font-black text-red-600">0.00</span>
        </div>
    </div>

    <div id="inputCard" class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 mb-6 transition-all duration-300">
        <div id="editHeader" class="hidden mb-3 text-xs font-bold text-red-600 uppercase flex items-center gap-2">
            <i data-lucide="edit-3" class="w-3 h-3"></i> Bearbeitungsmodus
        </div>

        <button id="commuteBtn" onclick="applyCommute()" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-2xl flex items-center justify-between mb-4 active:bg-slate-100 transition-colors">
            <div class="text-left">
                <div class="font-bold text-slate-700 text-sm">üè† Pendeln: Lachen ‚Üî Glattpark</div>
                <div class="text-[10px] text-slate-400">Direkt CHF 10.70 buchen</div>
            </div>
            <i data-lucide="zap" class="text-red-600 w-5 h-5"></i>
        </button>

        <div class="grid grid-cols-2 gap-2 mb-3">
            <input type="date" id="mDate" class="p-3 bg-slate-50 border border-slate-100 rounded-xl text-xs outline-none focus:border-red-500 transition-colors">
            <input type="number" step="0.05" id="mPrice" placeholder="Leer = Auto-Preis" class="p-3 bg-slate-50 border border-slate-100 rounded-xl text-xs outline-none focus:border-red-500 transition-colors placeholder:text-red-300/50">
        </div>

        <div class="relative mb-3">
            <input type="text" id="mFrom" placeholder="Startbahnhof..." autocomplete="off" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-xs outline-none focus:border-red-500 transition-colors">
            <div id="mFromSuggestions" class="suggestions-container hidden"></div>
        </div>
        <div class="relative mb-4">
            <input type="text" id="mTo" placeholder="Zielbahnhof..." autocomplete="off" class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-xs outline-none focus:border-red-500 transition-colors">
            <div id="mToSuggestions" class="suggestions-container hidden"></div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="saveEntry()" id="btnSave" class="flex-1 bg-red-600 text-white py-4 rounded-2xl text-xs font-bold shadow-lg shadow-red-100 active:scale-95 transition-transform">
                Fahrt speichern
            </button>
            <button onclick="cancelEdit()" id="btnCancel" class="hidden px-4 bg-slate-100 text-slate-500 rounded-2xl text-xs font-bold">
                X
            </button>
        </div>
    </div>

    <div id="journeyList" class="space-y-3"></div>
</div>

<script>
    const GA_PRICE = 3995;
    const GA_EXPIRY = new Date('2026-08-11');
    let journeys = JSON.parse(localStorage.getItem('swissJourneys') || '[]');
    let editingId = null;

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('mDate').valueAsDate = new Date();
        setupAutocomplete('mFrom');
        setupAutocomplete('mTo');
        render();
    });

    // --- AUTOCOMPLETE ---
    function setupAutocomplete(fieldId) {
        const input = document.getElementById(fieldId);
        const container = document.getElementById(fieldId + 'Suggestions');
        let debounceTimer;

        input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const query = input.value.trim();
            if (query.length < 2) { container.classList.add('hidden'); return; }

            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`https://transport.opendata.ch/v1/locations?query=${encodeURIComponent(query)}&type=station`);
                    const data = await response.json();
                    if (data.stations && data.stations.length > 0) {
                        container.innerHTML = '';
                        container.classList.remove('hidden');
                        data.stations.slice(0, 5).forEach(station => {
                            const item = document.createElement('div');
                            item.className = 'suggestion-item';
                            item.innerText = station.name;
                            item.onclick = () => { input.value = station.name; container.classList.add('hidden'); };
                            container.appendChild(item);
                        });
                    } else { container.classList.add('hidden'); }
                } catch (e) {}
            }, 300);
        });
    }
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.relative')) document.querySelectorAll('.suggestions-container').forEach(c => c.classList.add('hidden'));
    });

    // --- LOGIC ---
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const pLat1 = parseFloat(lat1), pLon1 = parseFloat(lon1), pLat2 = parseFloat(lat2), pLon2 = parseFloat(lon2);
        const R = 6371;
        const dLat = (pLat2 - pLat1) * Math.PI / 180;
        const dLon = (pLon2 - pLon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(pLat1*Math.PI/180)*Math.cos(pLat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return parseFloat((R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * 1.25).toFixed(1));
    }

    function getCurrentAvgPrice() {
        const totalKM = journeys.reduce((s, j) => s + j.km, 0);
        const totalSpent = journeys.reduce((s, j) => s + j.price, 0);
        // Fallback auf 0.40 wenn keine Daten, sonst echter Schnitt
        return totalKM > 0 ? (totalSpent / totalKM) : 0.40;
    }

    async function applyCommute() {
        document.getElementById('mFrom').value = "Lachen, Bahnhof";
        document.getElementById('mTo').value = "Glattpark (Opfikon), Glattpark";
        document.getElementById('mPrice').value = "10.70";
        if(!editingId) await saveEntry(); 
    }

    async function saveEntry() {
        const from = document.getElementById('mFrom').value;
        const to = document.getElementById('mTo').value;
        let priceInput = document.getElementById('mPrice').value; // String holen
        const dateStr = document.getElementById('mDate').value;
        
        if(!from || !to) return alert("Bitte Start und Ziel eingeben");
        
        const btn = document.getElementById('btnSave');
        btn.innerText = "Berechne...";
        btn.disabled = true;

        try {
            const s1 = await fetch(`https://transport.opendata.ch/v1/locations?query=${encodeURIComponent(from)}`).then(r => r.json()).then(d => d.stations[0]);
            const s2 = await fetch(`https://transport.opendata.ch/v1/locations?query=${encodeURIComponent(to)}`).then(r => r.json()).then(d => d.stations[0]);

            const km = calculateDistance(s1.coordinate.x, s1.coordinate.y, s2.coordinate.x, s2.coordinate.y);
            
            // Preis-Automatik
            let price;
            if (!priceInput || priceInput.trim() === "") {
                const avg = getCurrentAvgPrice();
                price = parseFloat((km * avg).toFixed(2));
                // Optional: Kurzes Feedback k√∂nnte hier rein
            } else {
                price = parseFloat(priceInput);
            }

            const newEntry = { 
                id: editingId || Date.now(), 
                from: s1.name, 
                to: s2.name, 
                price, km, 
                date: new Date(dateStr).toISOString() 
            };

            if (editingId) {
                const index = journeys.findIndex(j => j.id === editingId);
                journeys[index] = newEntry;
                cancelEdit();
            } else {
                journeys.unshift(newEntry);
            }

            journeys.sort((a, b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('swissJourneys', JSON.stringify(journeys));
            
            if(!editingId) {
                document.getElementById('mFrom').value = '';
                document.getElementById('mTo').value = '';
                document.getElementById('mPrice').value = '';
            }
            render();
        } catch(e) {
            alert("Fehler: Bahnhof nicht gefunden! Bitte Schreibweise pr√ºfen.");
        } finally {
            btn.innerText = editingId ? "√Ñnderungen speichern" : "Fahrt speichern";
            btn.disabled = false;
        }
    }

    function editEntry(id) {
        const entry = journeys.find(j => j.id === id);
        if(!entry) return;

        editingId = id;
        document.getElementById('mFrom').value = entry.from;
        document.getElementById('mTo').value = entry.to;
        document.getElementById('mPrice').value = entry.price;
        document.getElementById('mDate').value = new Date(entry.date).toISOString().split('T')[0];
        
        document.getElementById('btnSave').innerText = "√Ñnderung speichern";
        document.getElementById('btnCancel').classList.remove('hidden');
        document.getElementById('inputCard').classList.add('edit-mode');
        document.getElementById('editHeader').classList.remove('hidden');
        document.getElementById('commuteBtn').classList.add('opacity-50', 'pointer-events-none');
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        editingId = null;
        document.getElementById('mFrom').value = '';
        document.getElementById('mTo').value = '';
        document.getElementById('mPrice').value = '';
        document.getElementById('mDate').valueAsDate = new Date();
        
        document.getElementById('btnSave').innerText = "Fahrt speichern";
        document.getElementById('btnCancel').classList.add('hidden');
        document.getElementById('inputCard').classList.remove('edit-mode');
        document.getElementById('editHeader').classList.add('hidden');
        document.getElementById('commuteBtn').classList.remove('opacity-50', 'pointer-events-none');
    }

    function deleteEntry(id) {
        if(confirm("Eintrag wirklich l√∂schen?")) {
            journeys = journeys.filter(j => j.id !== id);
            localStorage.setItem('swissJourneys', JSON.stringify(journeys));
            if(editingId === id) cancelEdit();
            render();
        }
    }

    function render() {
        const totalKM = journeys.reduce((s, j) => s + j.km, 0);
        const totalSpent = journeys.reduce((s, j) => s + j.price, 0);
        const avg = totalKM > 0 ? (totalSpent / totalKM) : 0;

        document.getElementById('totalKM').innerText = totalKM.toFixed(1);
        document.getElementById('avgPrice').innerText = avg.toFixed(2);
        
        // GA Zyklus
        const cycleStart = new Date(GA_EXPIRY);
        cycleStart.setFullYear(GA_EXPIRY.getFullYear() - 1); 
        const cycleTrips = journeys.filter(j => new Date(j.date) >= cycleStart);
        const spentInCycle = cycleTrips.reduce((s, j) => s + j.price, 0);
        
        // Prognose Logik
        const uniqueDays = new Set(cycleTrips.map(j => new Date(j.date).toDateString())).size;
        document.getElementById('spentLabel').innerText = `Aktuell: CHF ${spentInCycle.toFixed(2)}`;

        if (uniqueDays >= 3) {
            const firstTrip = new Date(cycleTrips[cycleTrips.length-1].date);
            const today = new Date();
            const daysTracking = Math.max(1, Math.ceil((today - firstTrip) / (1000*60*60*24)));
            
            const projected = (spentInCycle / daysTracking) * 365;
            document.getElementById('projectedYear').innerText = Math.round(projected).toLocaleString();
            document.getElementById('predictionMsg').innerText = projected > GA_PRICE 
                ? `GA lohnt sich! (ca. CHF ${Math.round(projected)} / Jahr)`
                : `Einzelbillette g√ºnstiger (ca. CHF ${Math.round(projected)} / Jahr)`;
            document.getElementById('dataBadge').classList.add('hidden');
        } else {
            document.getElementById('projectedYear').innerText = "---";
            document.getElementById('predictionMsg').innerText = `Sammle Daten (${uniqueDays}/3 Tage)...`;
            document.getElementById('dataBadge').classList.remove('hidden');
        }

        document.getElementById('gaProgress').style.width = Math.min((spentInCycle / GA_PRICE) * 100, 100) + '%';

        const list = document.getElementById('journeyList');
        list.innerHTML = '';
        journeys.forEach(j => {
            const autoPriceBadge = (j.price / j.km).toFixed(2) === avg.toFixed(2) ? '' : ''; // Optional logic
            
            list.innerHTML += `
            <div class="bg-white p-4 rounded-3xl border border-slate-100 flex justify-between items-center shadow-sm">
                <div class="flex-1 truncate pr-3">
                    <div class="font-bold text-slate-800 text-xs truncate">${j.from} ‚Üí ${j.to}</div>
                    <div class="text-[9px] text-slate-400 font-bold uppercase tracking-tight">
                        ${new Date(j.date).toLocaleDateString('de-CH')} ‚Ä¢ ${j.km} km
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="text-red-600 font-black text-xs text-right mr-1">CHF ${j.price.toFixed(2)}</div>
                    <button onclick="editEntry(${j.id})" class="p-1.5 bg-slate-50 text-slate-400 rounded-lg hover:text-blue-500 hover:bg-blue-50">
                        <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="deleteEntry(${j.id})" class="p-1.5 bg-slate-50 text-slate-400 rounded-lg hover:text-red-500 hover:bg-red-50">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            </div>`;
        });
        lucide.createIcons();
    }
    
    function backupData() {
        const blob = new Blob([JSON.stringify(journeys)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'swisstrack_backup.json'; a.click();
    }
</script>
</body>
</html>
